<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/signned.css">
</head>

<body>
    <div class="head">
        <h2>Welcome to chat app</h2>
        <a href="./sign_in.html" class="log">Log out</a>
    </div>
    <hr>
    <br>
    <div class="chating" id="boxx">
        <!-- <div class="chatother">
            <h3 class="textothers">Ram:Hi There</h3>
        </div>
        <div class="chatother">
            <h3 class="textothers">Ram:Hi There</h3>
        </div>
        <div class="chatother">
            <h3 class="textothers">Ram:Hi There</h3>
        </div>
        <div class="chatother">
            <h3 class="textothers">Ram:Hi There</h3>
        </div>
        <div class="chatyou">
            <h3 class="textyou">You:Hi There</h3>
        </div> -->
    </div>
    <div class="chat">
        <form id="form">
            <input type="text" id="messag" placeholder="plese write massage here" required>
            <button class="sendbutt" id="sendbutt" type="submit">
                Send
            </button>
        </form>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const token = localStorage.getItem("TOKEN")
    const box = document.getElementById("boxx")
    document.getElementById('form').addEventListener("submit", sendmess)
    window.addEventListener("DOMContentLoaded", () => {
        addtols()
        autoloader()
    })
    async function addtols() {
        var lastmsgid = 0;
        if (localStorage.getItem("massages") == null) {
            const arr = [];
            localStorage.setItem("massages", JSON.stringify(arr));
        } else {
            const massages = JSON.parse(localStorage.getItem("massages"))
            if (massages.length == 0) {
            } else {
                lastmsgid = massages[massages.length - 1].id
                massages.forEach(element => {
                    const div = document.createElement("div");
                    const h3 = document.createElement("h3");
                    var newobj = {}
                    if (element.sender == "You") {
                        div.className = "chatyou";
                        h3.className = "textyou";
                        h3.innerHTML = "You" + " - " + element.massages
                    } else {
                        div.className = "chatother";
                        h3.className = "textothers";
                        h3.innerHTML = element.sender + " - " + element.massages
                    }
                    box.appendChild(div);
                    div.appendChild(h3)
                });
            }
        }
        pageloader(lastmsgid)
    }
    async function pageloader(lastmsgid) {
        try {
            const config = {
                url: "http://localhost:3000/group/getsmss/" + lastmsgid,
                method: "GET",
                headers: { "token": token }
            }
            const masages = await axios(config);
            const messages = masages.data.messages;
            const userid = masages.data.userId;
            if (messages.length >= 1) {
                await loadexp(messages, userid)
                box.scrollTop = box.scrollHeight - box.clientHeight;
            }
        } catch (err) {
            console.log(err)
        }
    }
    async function loadexp(messages, userid) {
        var lsdata = localStorage.getItem("massages")
        lsdata = JSON.parse(lsdata);
        messages.forEach(element => {
            const div = document.createElement("div");
            const h3 = document.createElement("h3");
            var newobj = {}
            if (element.userId == userid) {
                div.className = "chatyou";
                h3.className = "textyou";
                h3.innerHTML = "You" + " - " + element.massage
                newobj = {
                    id: element.id,
                    massages: element.massage,
                    sender: "You"
                }
            } else {
                div.className = "chatother";
                h3.className = "textothers";
                h3.innerHTML = element.name + " - " + element.massage
                newobj = {
                    id: element.id,
                    massages: element.massage,
                    sender: element.name
                }
            }
            box.appendChild(div);
            div.appendChild(h3)
            lsdata.push(newobj)
        });
        lsdata = JSON.stringify(lsdata);
        localStorage.setItem("massages", lsdata)
    }
    async function sendmess() {
        try {
            var message = document.getElementById('messag').value
            const config = {
                method: "POST",
                url: "http://localhost:3000/group/sendmess",
                data: {
                    'message': message
                },
                headers: {
                    "token": token
                }
            }
            await axios(config)

        } catch (err) {
            console.log(err)
        }
    }
    async function autoloader() {
        setInterval(() => {
            var lastid = JSON.parse(localStorage.getItem("massages"));
            lastid = lastid[lastid.length - 1].id;
            if (lastid == undefined) {
                pageloader('0');
            } else {
                pageloader(lastid)
            }
        }, 1000)
    }

</script>

</html>