<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/signned.css">
</head>

<body>
    <div class="head">
        <h2>Welcome to chat app</h2>
        <a href="./sign_in.html" class="log">Log out</a>
    </div>
    <br>
    <div class="parent">
        <div class="child1">
            <div class="groupdiv1">
                <h3 class="groupname1">Create a group</h3>
            </div>
            <div id="datas">
                <!-- <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div>
                <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div>
                <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div> -->
                <!-- <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div>
                <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div>
                <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div>
                <div class="groupdiv">
                    <h3 class="groupname">Hero</h3>
                </div> -->
            </div>
        </div>
        <div class="child2">
            <div class="groupinfo">
                <h3 class="groupname3"></h3>
            </div>
            <div class="sharewithother">
                <span>you can share this link also to invite others to the group</span>
                <br>
                <br>
                <span id="spanlink">you can share this link also to invite others to the group</span>
            </div>
            <div class="sharewithother2">
                <input type="text" placeholder="enter email or phone to send invite" required id="sendinvitedet">
                <button class="sendbutt" id="sendinvit" type="submit">
                    Invite
                </button>
                <br>
                <span id="statussending"></span>
                <div>
                    
                </div>
            </div>
            <div class="chating" id="boxx">
                <h2 class="selecttext">Select group to view chats</h2>
                <!-- <div class="chatother">
                    <h3 class="textothers">Ram:Hi There</h3>
                </div>
                <div class="chatother">
                    <h3 class="textothers">Ram:Hi There</h3>
                </div>
                <div class="chatother">
                    <h3 class="textothers">Ram:Hi There</h3>
                </div>
                <div class="chatyou">
                    <h3 class="textyou">You:Hi There</h3>
                </div> -->
            </div>
            <div class="chat">
                <form id="form">
                    <input type="text" id="messag" placeholder="plese write massage here" required>
                    <button class="sendbutt" id="sendbutt" type="submit">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>
    <hr>
    <br>
    <hr>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    var timeoutforoption;
    const statussendingmail = document.getElementById("statussending")
    const sendinvitedetails = document.getElementById("sendinvitedet").value
    const sharewithother = document.querySelector(".sharewithother")
    const sharewithother2 = document.querySelector(".sharewithother2")
    document.getElementById('sendinvit').addEventListener("click", sendinvite)
    const groupname3 = document.querySelector('.groupname3');
    const groupinfo = document.querySelector('.groupinfo');
    document.querySelector('.groupname1').addEventListener("click", creategroup);
    const token = localStorage.getItem("TOKEN")
    const box = document.getElementById("boxx")
    const chat = document.querySelector(".chat")
    document.getElementById('form').addEventListener("submit", sendmess)
    window.addEventListener("DOMContentLoaded", async () => {
        await pageloader2()
    })
    async function sendmess(e) {
        e.preventDefault()
        try {
            const message = document.getElementById('messag').value
            const currentgroup = await localStorage.getItem("currentgroup")
            const config = {
                method: "POST",
                url: "http://localhost:3000/group/sendmess",
                data: {
                    message: message,
                    group_id: currentgroup
                },
                headers: {
                    "token": token
                }
            }
            await axios(config)
            const config2 = {
                url: "http://localhost:3000/group/getsmss/" + currentgroup,
                method: "GET",
                headers: { "token": token }
            }
            const masages = await axios(config2);
            const messages = masages.data.messages;
            const userid = masages.data.userId;
            await loadexp(messages, userid)
            box.scrollTop = box.scrollHeight - box.clientHeight;
        } catch (err) {
            console.log(err)
        }
    }
    async function creategroup() {
        let promt = prompt("Please enter group name");
        try {
            if (promt == "") {
                return
            } else {
                const config = {
                    method: "POST",
                    url: "http://localhost:3000/group/creategroup",
                    data: {
                        groupname: promt,
                        datenow: Date.now()
                    },
                    headers: {
                        "token": token
                    }
                }
                const res = await axios(config)

                await pageloader2()
            }

        } catch (err) {
            console.log(err)
        }
    }
    async function pageloader2() {
        try {
            const config = {
                url: "http://localhost:3000/group/getgroup",
                method: "get",
                headers: {
                    "token": token
                }
            }
            const data1 = await axios(config);
            if (data1) {
                const datasa = document.getElementById('datas')
                datasa.innerHTML = ""
                data1.data.data.forEach(element => {
                    const div = document.createElement("div")
                    const h3 = document.createElement("h3")
                    const input = document.createElement("input")
                    const inputad = document.createElement("input")
                    input.type = "hidden"
                    input.value = element.group_id
                    inputad.value = element.role
                    inputad.type = "hidden"
                    div.className = "groupdiv"
                    h3.className = "groupname"
                    h3.innerHTML = element.name

                    div.appendChild(input);
                    div.appendChild(inputad);
                    div.appendChild(h3);
                    datasa.appendChild(div)
                    h3.addEventListener('click', loadmsg)
                })
            }
        } catch (err) {
            console.log(err)
        }
    }
    async function loadmsg(e) {
        const par = e.target.parentElement;
        var id = par.firstChild
        var groupname = par.children[2]
        var role = par.children[1]
        id = id.value
        await localStorage.setItem("currentgroup", id)
        try {
            const config = {
                url: "http://localhost:3000/group/getsmss/" + id,
                method: "GET",
                headers: { "token": token }
            }
            const masages = await axios(config);
            const messages = masages.data.messages;
            const userid = masages.data.userId;
            await loadexp(messages, userid)
            box.scrollTop = box.scrollHeight - box.clientHeight;
            groupinfo.style.display = "block";
            groupname3.innerHTML = groupname.innerHTML
            statussendingmail.innerHTML = ""
            var sendinvitedetails = document.getElementById("sendinvitedet")
            sendinvitedetails.value = ""
            const spanlinkk = document.getElementById('spanlink')
            spanlinkk.innerHTML = ""
            if (role.value === "Admin") {
                groupinfo.addEventListener("click", loadgroupinfoadmin)
            } else {
                groupinfo.addEventListener("click", loadgroupinfo)

            }
        } catch (err) {
            console.log(err)
        }
    }
    async function loadexp(messages, userid) {
        const box = document.getElementById("boxx")
        box.innerHTML = ""
        chat.style.display = "block"
        sharewithother.style.display = "none"
        sharewithother2.style.display = "none"

        messages.forEach(element => {
            const div = document.createElement("div");
            const h3 = document.createElement("h3");
            if (element.userId == userid) {
                div.className = "chatyou";
                h3.className = "textyou";
                h3.innerHTML = "You" + " - " + element.massage
            } else {
                div.className = "chatother";
                h3.className = "textothers";
                h3.innerHTML = element.name + " - " + element.massage
            }
            box.appendChild(div);
            div.appendChild(h3)
        });
    }
    async function loadgroupinfoadmin() {

        box.innerHTML = "";
        chat.style.display = "none"
        const spanlinkk = document.getElementById('spanlink')
        const groupid = localStorage.getItem("currentgroup")
        spanlinkk.innerHTML = "http://localhost:3000/admin/inviteother/" + groupid
        sharewithother.style.display = "block"
        sharewithother2.style.display = "block"
    }
    async function sendinvite() {
        const sendinvitedetails = document.getElementById("sendinvitedet").value

        if (sendinvitedetails == "") {

            statussendingmail.innerHTML = "please enter Email or phone no"
            statussendingmail.style.color = "red"
        } else {
            try {
                const groupid = localStorage.getItem("currentgroup")
                const config = {
                    url: "http://localhost:3000/admin/invitesearch",
                    method: "POST",
                    data: {
                        invitedetails: sendinvitedetails,
                        group_id: groupid,
                        group_name: groupname3.innerHTML
                    },
                    headers: {
                        "token": token
                    }
                }
                const users = await axios(config)
                statussendingmail.innerHTML = "Added " + users.data.data.name + " to the group"
                statussendingmail.style.color = "green"
            } catch (err) {
                console.log(err)
                if (err.response.status == 404) {
                    statussendingmail.innerHTML = "invalid Email or phone no"
                    statussendingmail.style.color = "red"
                } else if (err.response.status == 500) {
                    statussendingmail.innerHTML = "Something went wrong"
                    statussendingmail.style.color = "red"
                } else if (err.response.status == 503) {
                    statussendingmail.innerHTML = "Already a member"
                    statussendingmail.style.color = "red"
                }
            }
        }
    }
    async function loadgroupinfo(){

    }
</script>

</html>